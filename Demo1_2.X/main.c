// Files generated by MCC 
#include <stdint.h>
#include <stdbool.h>
#include <stdio.h>

#include "mcc_generated_files/system.h"
#include "helper_funcs.c"
#include "leds.h"
#include "buttons.h"
#include "buttons.c"
#include "timer_1ms.c"
#include "timer_1ms.h"
#include "adc.c"
#include "adc.h"

#define BUTTON_DEBOUNCE_TIME 25000

//------------------------------------------------------------------------------
//Global variables
//------------------------------------------------------------------------------
static volatile BUTTON_COLOR buttonColor = BUTTON_COLOR_RED;


int main(void)
{
    // initialize the device
    SYSTEM_Initialize(); 

    // Enable buttons as inputs
    BUTTON_Enable(BUTTON_S1);

    // Set the time
    TIMER_SetConfiguration(TIMER_CONFIGURATION_1MS);

    //Enable and configure the ADC so it can sample the potentiometer.
    ADC_SetConfiguration(ADC_CONFIGURATION_DEFAULT);
    ADC_ChannelEnable(ADC_CHANNEL_POTENTIOMETER);

    FLAGS flags;
    flags.all_flags = 0; // Set all flags to zero

    uint16_t potentiometer = 0;

    // // PWM Module 
     // RB11/RB10 as output
    TRISBbits.TRISB11 = 0;
    TRISBbits.TRISB10 = 0; // Set RB10/11 as outputs

    PWM_GENERATOR pwm4 = PWM_GENERATOR_4;
    PWM_GENERATOR pwm3 = PWM_GENERATOR_3;

    PWM_ModuleDisable(pwm4);
    PG4CONHbits.MDCSEL = 0; // Disable master dc
    PG4CONHbits.MPERSEL = 0;
    PG4CONHbits.MPHSEL = 0;
    PWM_DutyCycleSet(pwm4, 0x0FFF);
    PWM_PeriodSet(pwm4, 0x7CFF); // This works to set period and duty cycle

    PWM_ModuleDisable(pwm3);
    PG3CONHbits.MDCSEL = 0; 
    PG3CONHbits.MPERSEL = 0;
    PG3CONHbits.MPHSEL = 0;
    PWM_DutyCycleSet(pwm3, 0x2EFE);
    PWM_PeriodSet(pwm3, 0x7CEF); // This does not work for PWM3, or I can't find pin.

    // PG3IOCONLbits.SWAP = 0; 
    // PG3IOCONLbits.OVRENH = 0; 
    // PG3IOCONLbits.OVRENL = 0;

    // PG3IOCONHbits.PENH = 1;
    // PG3IOCONHbits.PENL = 1; // Trying to map PWM3 to pins.
    // PG3IOCONHbits.PMOD = 0x02; // Independent mode


    PWM_ModuleEnable(pwm3);


    while (1)
    {
        lib_blink(&flags);
        
        if(BUTTON_IsPressed(BUTTON_S1) == 1){
            // Debounce
            lib_stall(BUTTON_DEBOUNCE_TIME); // Wait
            flags.btn_pressed = BUTTON_IsPressed(BUTTON_S1) == 1; // Button still pressed?
            flags.reliable = flags.btn_pressed == 1; 
            if(!flags.reliable) flags.btn_pressed = 0;

            flags.toggle = !flags.toggle;
            PIN_D9 = flags.toggle; 
        }

        if(flags.toggle == 0){
            PWM_ModuleDisable(pwm4);
        }
        else if(flags.toggle == 1){
            PWM_ModuleEnable(pwm4);
        }

        potentiometer = ADC_ReadPercentage(ADC_CHANNEL_POTENTIOMETER);
        set_RGB_LED(potentiometer);
    }

}
